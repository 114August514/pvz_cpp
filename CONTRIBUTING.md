# 🛠 PVZ_CPP 开发技术协议

本文档定义了本项目开发的技术标准与协作流程，旨在确保 C++ 核心层与 Python 脚本层的高效集成，并维护代码库的严谨性。

## 1. 系统架构与语言边界

项目采用“底层引擎 + 高层脚本”架构。开发时必须严格遵守语言分工边界，禁止越权开发：

* **C++ 核心层 (`/core`)**：
  * **职责**：负责游戏循环、渲染管线、物理碰撞检测算法、内存管理、基础基类定义。
  * **限制**：禁止硬编码具体的平衡性数值（如 HP、攻击力、冷却时间）。
* **Python 脚本层 (`/scripts`)**：
  * **职责**：负责具体实体的 AI 逻辑、关卡波次配置、UI 交互、数值平衡。
  * **限制**：禁止处理每帧超过 1000 次以上的像素级数学运算。
* **数据层 (`/data`)**：
  * **职责**：统一使用 YAML 格式，存储所有平衡性参数。

## 2. 代码规范 (Coding Standards)

### 2.1 C++ 规范

* **标准**：采用 C++17 标准。
* **命名**：
  * 类名使用 `PascalCase`（例：`EntityManager`）。
  * 函数与变量使用 `camelCase`（例：`getHealth()`）。
  * 成员变量统一加 `m_` 前缀（例：`m_position`）。
* **内存管理**：
  * 禁止直接使用 `new` / `delete`。
  * 必须使用智能指针：`std::unique_ptr` 用于管理所有权，`std::shared_ptr` 用于跨模块引用，`std::weak_ptr` 用于解决循环引用。
* **接口**：所有基类析构函数必须声明为 `virtual`。

### 2.2 Python 规范

* **标准**：遵循 PEP8 规范。
* **命名**：变量与函数使用 `snake_case`（例：`spawn_zombie`）。
* **类型提示**：公开接口必须包含 Type Hints（例：`def apply_damage(self, amount: int) -> None:`）。

### 2.3 YAML 配置规范

* **文件后缀**：统一使用 .yaml。
* **缩进**：固定为 2 个空格，严禁使用 Tab。
* **命名**：键名（Key）使用 snake_case（例：attack_damage: 20）。
* **结构划分**：
  * /data/plants/：每种植物独立一个文件。
  * /data/zombies/：每种僵尸独立一个文件。
  * /data/levels/：定义关卡波次（Wave）与掉落逻辑。

## 3. 类设计与对象协议 (OOP Protocol)

为确保“深入理解类”的学习目标，类设计需遵守以下约束：

1. **继承深度限制**：实体继承链不得超过 3 层（例：`GameObject` -> `Plant` -> `Peashooter`）。
2. **组合优于继承**：对于非生物属性（如动画控制器、碰撞盒），应作为成员变量组合进类中，而非通过继承获得。
3. **虚函数约束**：
    * `onUpdate(float dt)`：处理逻辑更新。
    * `onRender()`：处理渲染逻辑。
    * `onDestroy()`：处理资源释放前的清理。

## 4. 注释与文档规范 (Documentation Standards)

注释的原则是：**代码表达“如何做”，注释表达“为什么做”**。

### 4.1 C++ 注释规范 (Doxygen 风格)

* **头文件 (.h)**：所有公开接口必须在头文件中书写注释，说明函数功能、参数及返回值。使用 `/** ... */` 风格。

    ```cpp
    /**
     * @brief 计算子弹与实体的碰撞
     * @param entity 指向目标实体的指针
     * @return bool 是否发生碰撞
     * @note 此处采用 AABB 算法，暂不考虑精细像素碰撞
     */
    bool checkCollision(Entity* entity);
    ```

* **源文件 (.cpp)**：仅在实现逻辑极其复杂或存在“魔法数字”时编写内联注释。
* **状态管理**：复杂的枚举常量或状态机分支必须注明各状态含义。

### 4.2 Python 注释规范 (Docstring 风格)

* **类与函数**：使用 PEP 257 标准的 Docstrings（三引号）。
  
    ```python
    def spawn_zombie(self, zombie_type: str, row: int):
        """
        在指定行生成僵尸实例。
        
        Args:
            zombie_type: 僵尸类型字符串，需对应 YAML 中的 ID
            row: 目标行号 (0-4)
        """
        pass
    ```

### 4.3 跨语言绑定注释 (Binding)

* 在 `bindings/` 目录下的导出代码中，必须注明 C++ 对象在 Python 中的生命周期由谁负责（由 C++ 管理还是由 Python GC 销毁）。

### 4.4 维护标记 (Standard Tags)

统一使用以下标记来追踪代码状态，标记后需注明责任人：

* `// TODO(name):` 待实现的功能。
* `// FIXME(name):` 已知存在 Bug 需修复的代码。
* `// NOTE(name):` 强调此处逻辑的特殊性（例如：为了性能牺牲了精度）。

---

## 5. 数据与坐标协议

* **时间单位**：全局统一使用 **秒 (seconds)** 作为 float 型变量，严禁使用帧数 (frames) 作为计时单位。
* **空间单位**：
  * **网格坐标**：行 `0-4`，列 `0-8`。
  * **像素坐标**：基于 2D 渲染引擎的绝对像素值。
  * **转换**：坐标转换必须调用 `GridSystem` 工具类，禁止在逻辑代码中硬编码偏移量。
* **资源路径**：代码中引用的资源路径必须为相对于项目根目录的**相对路径**。

## 6. Python 依赖管理

1. 本项目使用 `uv` 管理依赖。
2. 开始开发前，请执行 `uv venv` 和 `uv sync`。
3. 所有的 Python 逻辑测试请确保在 `.venv` 环境下运行。
4. 新增 Python 依赖请使用 `uv add <package>`，并提交更新后的 `pyproject.toml`。

## 7. Git 协作规矩

* **分支管理**：
  * `main` 分支保持 Read-only，仅接受 PR 合并。
  * 开发分支命名格式：`feat-[功能名]` 或 `fix-[问题名]`。
* **提交消息 (Commit Message)**：
  * 格式：`[模块名] 简述`。
  * 示例：`[core] 优化 CollisionSystem 空间分割算法`
  * 示例：`[script] 修复向日葵产阳光频率异常`
* **二进制管控**：
  * 严禁提交 `build/`, `bin/`, `.pyd`, `.so`, `.obj` 等编译产物。
  * 大型素材文件（>50MB）需通过 Git LFS 处理。

## 8. 环境一致性检查

在提交代码前，开发者必须确保：

1. **CMake 成功**：本地增量编译无 Error。
2. **脚本运行**：Python 启动脚本无 `ImportError`。
3. **依赖更新**：若引入新库，必须同步更新对应的依赖配置文件。

   * 若新增 Python 依赖，请执行 `uv add <package>`，并提交更新后的 `pyproject.toml` 和 `uv.lock`。
   * 若新增 C++ 相关依赖，请同步更新对应的 `CMakeLists.txt`。
   * 禁止手动修改 `pyproject.toml` 中的版本号（应使用 `uv add` 管理）。

4. **本地环境**：在 `.venv` 环境下测试，确保依赖兼容性。

---
**本协议自发布之日起执行。如有修改需求，需经团队成员讨论通过。**
